# å¤š Webview å•çª—å£æ–¹æ¡ˆ - å®ç°è¯´æ˜

## âœ… å·²å®Œæˆä¿®æ”¹

ç°åœ¨åº”ç”¨å·²æ”¹ä¸º**å¤š webview å•çª—å£**æ¨¡å¼ï¼Œç‚¹å‡»æŒ‰é’®åœ¨åŒä¸€çª—å£å†…åˆ‡æ¢ä¸åŒçš„ç‹¬ç«‹ webviewï¼Œå®Œå…¨è§£å†³ iframe çš„ç¯å¢ƒæ£€æµ‹é—®é¢˜ã€‚

## ğŸ¯ æ ¸å¿ƒæ¶æ„

### æ¶æ„å›¾

```
ä¸»çª—å£ ("main") - 1400x900px
â”œâ”€â”€ é¡¶éƒ¨å¯¼èˆªæ  (60px é«˜åº¦)
â”‚   â”œâ”€â”€ [Studio é¡¹ç›®] æŒ‰é’®
â”‚   â”œâ”€â”€ [é¡¹ç›® 2] æŒ‰é’®
â”‚   â”œâ”€â”€ [é¡¹ç›® 3] æŒ‰é’®
â”‚   â””â”€â”€ å½“å‰é¡¹ç›®æŒ‡ç¤ºå™¨
â”‚
â””â”€â”€ å­ Webview çª—å£ï¼ˆå åŠ åœ¨ä¸»çª—å£ä¸‹æ–¹ï¼‰
    â”œâ”€â”€ studio-webview (éšè—/æ˜¾ç¤º)
    â”‚   â””â”€â”€ URL: myapp://studio/
    â”œâ”€â”€ project2-webview (éšè—/æ˜¾ç¤º)
    â”‚   â””â”€â”€ URL: myapp://project2/
    â””â”€â”€ project3-webview (éšè—/æ˜¾ç¤º)
        â””â”€â”€ URL: myapp://project3/
```

### å…³é”®ç‰¹æ€§

1. **ç‹¬ç«‹ Webview**ï¼šæ¯ä¸ªé¡¹ç›®åœ¨ç‹¬ç«‹çš„ WebviewWindow ä¸­è¿è¡Œ
2. **æ‡’åŠ è½½**ï¼šåªåœ¨é¦–æ¬¡ç‚¹å‡»æ—¶åˆ›å»º webviewï¼Œä¹‹åä¿æŒå­˜åœ¨
3. **ä½ç½®åŒæ­¥**ï¼šä¸»çª—å£ç§»åŠ¨/è°ƒæ•´å¤§å°æ—¶ï¼Œæ‰€æœ‰ webview è‡ªåŠ¨è·Ÿéš
4. **çŠ¶æ€ä¿æŒ**ï¼šåˆ‡æ¢é¡¹ç›®æ—¶çŠ¶æ€ä¸ä¸¢å¤±
5. **å®Œå…¨éš”ç¦»**ï¼šæ¯ä¸ª webview éƒ½è®¤ä¸ºè‡ªå·±æ˜¯ç‹¬ç«‹çª—å£

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. Rust åç«¯å‘½ä»¤

#### `switch_project(project_id)` - åˆ‡æ¢é¡¹ç›®

```rust
åŠŸèƒ½ï¼š
1. éšè—æ‰€æœ‰å…¶ä»–é¡¹ç›®çš„ webview
2. æ£€æŸ¥ç›®æ ‡ webview æ˜¯å¦å­˜åœ¨
   - å¦‚æœå­˜åœ¨ï¼šç›´æ¥æ˜¾ç¤ºå¹¶èšç„¦
   - å¦‚æœä¸å­˜åœ¨ï¼šåˆ›å»ºæ–°çš„ webviewï¼ˆæ‡’åŠ è½½ï¼‰
3. æ›´æ–°å½“å‰é¡¹ç›®çŠ¶æ€

åˆ›å»ºçš„ webview é…ç½®ï¼š
- ä½ç½®ï¼šä¸»çª—å£ä¸‹æ–¹ï¼ˆy + 60pxï¼‰
- å¤§å°ï¼šä¸»çª—å£å†…å®¹åŒºåŸŸï¼ˆwidth x height-60ï¼‰
- decorations: falseï¼ˆæ— è¾¹æ¡†ï¼‰
- skip_taskbar: trueï¼ˆä¸æ˜¾ç¤ºåœ¨ä»»åŠ¡æ ï¼‰
- resizable: falseï¼ˆç”±ä¸»çª—å£æ§åˆ¶ï¼‰
```

#### `sync_webview_positions()` - åŒæ­¥ä½ç½®

```rust
åŠŸèƒ½ï¼š
å½“ä¸»çª—å£ç§»åŠ¨æˆ–è°ƒæ•´å¤§å°æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æ‰€æœ‰é¡¹ç›® webview çš„ä½ç½®å’Œå¤§å°
```

#### `close_project(project_id)` - å…³é—­é¡¹ç›®

```rust
åŠŸèƒ½ï¼š
æ‰‹åŠ¨å…³é—­æŸä¸ªé¡¹ç›®çš„ webviewï¼ˆé‡Šæ”¾å†…å­˜ï¼‰
```

### 2. å‰ç«¯å®ç°

#### é¡¹ç›®åˆ‡æ¢æµç¨‹

```typescript
1. ç”¨æˆ·ç‚¹å‡» "Studio é¡¹ç›®" æŒ‰é’®
   â†“
2. setLoading("studio") - æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
   â†“
3. invoke('switch_project', { projectId: 'studio' })
   â†“
4. Rust åç«¯ï¼š
   - éšè—å…¶ä»– webview
   - æ˜¾ç¤ºæˆ–åˆ›å»º studio-webview
   â†“
5. setTimeout(() => setLoading(null), 500)
   - æ¸…é™¤åŠ è½½çŠ¶æ€
```

#### çª—å£äº‹ä»¶ç›‘å¬

```typescript
useEffect(() => {
  const mainWindow = getCurrentWindow();

  // ç›‘å¬çª—å£ç§»åŠ¨
  mainWindow.onMoved(() => {
    invoke('sync_webview_positions');
  });

  // ç›‘å¬çª—å£è°ƒæ•´å¤§å°
  mainWindow.onResized(() => {
    invoke('sync_webview_positions');
  });
}, []);
```

## ğŸ†š å¯¹æ¯” iframe æ–¹æ¡ˆ

| æ£€æµ‹é¡¹ | iframe æ–¹æ¡ˆ | Webview æ–¹æ¡ˆ |
|--------|------------|-------------|
| `window.self === window.top` | âŒ false | âœ… true |
| `window.parent` | âŒ æŒ‡å‘ä¸»çª—å£ | âœ… æŒ‡å‘è‡ªå·± |
| ç¯å¢ƒæ£€æµ‹ | âŒ æ£€æµ‹åˆ° iframe | âœ… ç‹¬ç«‹çª—å£ |
| API URL | âŒ ä½¿ç”¨å¼€å‘ API | âœ… ä½¿ç”¨ç”Ÿäº§ API |
| Cookies | âŒ SameSite é™åˆ¶ | âœ… æ­£å¸¸å·¥ä½œ |
| localStorage | âš ï¸ å…±äº« | âœ… ç‹¬ç«‹ |
| æ€§èƒ½ | âš ï¸ ä¸€èˆ¬ | âœ… åŸç”Ÿ |
| å†…å­˜å ç”¨ | âœ… è¾ƒä½ | âš ï¸ è¾ƒé«˜ |

## ğŸ“‚ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `src-tauri/src/lib.rs`

**æ–°å¢å†…å®¹**ï¼š
- `AppState` ç»“æ„ä½“ï¼šè®°å½•å½“å‰é¡¹ç›®
- `switch_project()` å‘½ä»¤ï¼šåˆ‡æ¢é¡¹ç›® webview
- `close_project()` å‘½ä»¤ï¼šå…³é—­é¡¹ç›® webview
- `sync_webview_positions()` å‘½ä»¤ï¼šåŒæ­¥çª—å£ä½ç½®

**ç§»é™¤å†…å®¹**ï¼š
- `open_project()` å‘½ä»¤ï¼ˆæ—§çš„å¤šçª—å£æ–¹æ¡ˆï¼‰

### 2. `src/App.tsx`

**æ–°å¢å†…å®¹**ï¼š
- `useEffect` ç›‘å¬çª—å£äº‹ä»¶
- `switchProject()` å‡½æ•°ä½¿ç”¨ Tauri å‘½ä»¤
- å½“å‰é¡¹ç›®æŒ‡ç¤ºå™¨

**ç§»é™¤å†…å®¹**ï¼š
- iframe ç›¸å…³ä»£ç 
- `loadedProjects` çŠ¶æ€ï¼ˆä¸å†éœ€è¦å‰ç«¯ç®¡ç†ï¼‰
- `iframeRefs`ï¼ˆä¸å†éœ€è¦ï¼‰

### 3. `src-tauri/tauri.conf.json`

**ä¿®æ”¹å†…å®¹**ï¼š
```json
{
  "app": {
    "windows": [
      {
        "label": "main",  // â† æ·»åŠ æ ‡ç­¾
        "title": "é¡¹ç›®ç®¡ç†å™¨",
        "width": 1400,
        "height": 900,
        "resizable": true,
        "center": true
      }
    ]
  }
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨åº”ç”¨

```bash
cd /Users/rwr/repo/tauri-app-test
pnpm tauri dev
```

### 2. æ“ä½œæµç¨‹

1. **é¦–æ¬¡æ‰“å¼€** â†’ æ˜¾ç¤ºæ¬¢è¿é¡µé¢
2. **ç‚¹å‡»é¡¹ç›®æŒ‰é’®/å¡ç‰‡** â†’ åˆ›å»ºå¹¶æ˜¾ç¤ºå¯¹åº”çš„ webview
3. **åˆ‡æ¢é¡¹ç›®** â†’ éšè—å½“å‰ï¼Œæ˜¾ç¤ºç›®æ ‡é¡¹ç›®
4. **å†æ¬¡åˆ‡æ¢å›æ¥** â†’ webview å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤ºï¼ˆçŠ¶æ€ä¿æŒï¼‰
5. **ç§»åŠ¨çª—å£** â†’ æ‰€æœ‰ webview è‡ªåŠ¨è·Ÿéš

## ğŸ¯ è§£å†³çš„é—®é¢˜

### âœ… ç¯å¢ƒæ£€æµ‹é—®é¢˜

**ä¹‹å‰ï¼ˆiframeï¼‰**ï¼š
```javascript
// åœ¨ Studio é¡¹ç›®çš„ä»£ç ä¸­
if (window.self !== window.top) {
  // æ£€æµ‹åˆ°åœ¨ iframe ä¸­
  apiUrl = "https://api.cluster-fluster.com";  // ä½¿ç”¨å¼€å‘ API âŒ
} else {
  apiUrl = "https://studio-server.jova.bio";   // ä½¿ç”¨ç”Ÿäº§ API
}
```

**ç°åœ¨ï¼ˆwebviewï¼‰**ï¼š
```javascript
// åœ¨ Studio é¡¹ç›®çš„ä»£ç ä¸­
console.log(window.self === window.top); // true âœ…
// åº”ç”¨è®¤ä¸ºåœ¨ç‹¬ç«‹çª—å£ä¸­
apiUrl = "https://studio-server.jova.bio";  // ä½¿ç”¨ç”Ÿäº§ API âœ…
```

### âœ… API è°ƒç”¨æ­£å¸¸

æ¯ä¸ª webview éƒ½æ˜¯å®Œå…¨ç‹¬ç«‹çš„ç¯å¢ƒï¼š
- âœ… ç‹¬ç«‹çš„ JavaScript ä¸Šä¸‹æ–‡
- âœ… ç‹¬ç«‹çš„ Cookies
- âœ… ç‹¬ç«‹çš„ localStorage
- âœ… ç‹¬ç«‹çš„ sessionStorage
- âœ… æ­£ç¡®çš„ç¯å¢ƒæ£€æµ‹

## ğŸ§ª æµ‹è¯•æ¸…å•

- [ ] ç‚¹å‡» "Studio é¡¹ç›®" â†’ åˆ›å»º webview
- [ ] ç‚¹å‡» "é¡¹ç›®2" â†’ åˆ‡æ¢åˆ°é¡¹ç›®2
- [ ] å†æ¬¡ç‚¹å‡» "Studio é¡¹ç›®" â†’ å¿«é€Ÿåˆ‡æ¢ï¼ŒçŠ¶æ€ä¿æŒ
- [ ] åœ¨ Studio ä¸­æ“ä½œ â†’ åˆ‡æ¢åˆ°é¡¹ç›®2 â†’ åˆ‡å› Studio â†’ çŠ¶æ€ä¿æŒ
- [ ] ç§»åŠ¨ä¸»çª—å£ â†’ æ‰€æœ‰ webview è·Ÿéšç§»åŠ¨
- [ ] è°ƒæ•´ä¸»çª—å£å¤§å° â†’ æ‰€æœ‰ webview åŒæ­¥è°ƒæ•´
- [ ] **æœ€é‡è¦**ï¼šæ£€æŸ¥ Studio çš„ API è°ƒç”¨æ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„ URL
  - æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆStudio webviewï¼‰
  - æ£€æŸ¥ç½‘ç»œè¯·æ±‚
  - éªŒè¯ URL æ˜¯ `https://studio-server.jova.bio` è€Œä¸æ˜¯ `https://api.cluster-fluster.com`

## ğŸ’¡ å·¥ä½œåŸç†

### Webview çª—å£åˆ›å»º

```rust
// å½“ç”¨æˆ·é¦–æ¬¡ç‚¹å‡» "Studio é¡¹ç›®"
let builder = WebviewWindowBuilder::new(
    &app_handle,
    "studio-webview",          // å”¯ä¸€æ ‡ç­¾
    WebviewUrl::External("myapp://studio/".parse().unwrap())
)
.title("studio é¡¹ç›®")
.position(window_x, window_y + 60)  // ä¸»çª—å£ä¸‹æ–¹
.inner_size(window_width, window_height - 60)
.decorations(false)         // æ— è¾¹æ¡†ï¼ˆçœ‹èµ·æ¥åƒåµŒå…¥çš„ï¼‰
.skip_taskbar(true)         // ä¸æ˜¾ç¤ºä»»åŠ¡æ å›¾æ ‡
.visible(true);             // åˆ›å»ºåç«‹å³æ˜¾ç¤º

builder.build()?;
```

### çª—å£åˆ‡æ¢

```rust
// å½“ç”¨æˆ·åˆ‡æ¢åˆ° "é¡¹ç›®2"
// 1. éšè— studio-webview
studio_webview.hide()?;

// 2. æ˜¾ç¤º project2-webview
project2_webview.show()?;
project2_webview.set_focus()?;
```

## ğŸ‰ ä¼˜åŠ¿æ€»ç»“

1. **å®Œå…¨éš”ç¦»** - æ¯ä¸ªé¡¹ç›®éƒ½è®¤ä¸ºè‡ªå·±åœ¨ç‹¬ç«‹çª—å£ä¸­
2. **API æ­£å¸¸** - ç¯å¢ƒæ£€æµ‹é€»è¾‘æŒ‰é¢„æœŸå·¥ä½œ
3. **çŠ¶æ€ä¿æŒ** - åˆ‡æ¢é¡¹ç›®æ—¶çŠ¶æ€ä¸ä¸¢å¤±
4. **æ€§èƒ½ä¼˜ç§€** - åŸç”Ÿ webviewï¼Œæ—  iframe å¼€é”€
5. **ç”¨æˆ·ä½“éªŒ** - å•çª—å£ï¼Œæ“ä½œæµç•…
6. **æ— éœ€ä¿®æ”¹** - é¢„ç¼–è¯‘çš„ dist é¡¹ç›®æ— éœ€ä»»ä½•ä¿®æ”¹

## ğŸ” è°ƒè¯•

### æŸ¥çœ‹ Rust æ—¥å¿—

```bash
# ç»ˆç«¯ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—
ğŸ”„ åˆ‡æ¢é¡¹ç›®: studio
ğŸ™ˆ éšè— webview: project2-webview
â™»ï¸  webview å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º: studio-webview
âœ… webview åˆ›å»ºæˆåŠŸ
```

### æŸ¥çœ‹å‰ç«¯æ—¥å¿—

```javascript
// åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­
ğŸš€ æ­£åœ¨åˆ‡æ¢é¡¹ç›®: Studio é¡¹ç›®
âœ… é¡¹ç›®åˆ‡æ¢æˆåŠŸ: Studio é¡¹ç›®
```

### æ£€æŸ¥ webview æ•°é‡

```bash
# åœ¨ Rust ä»£ç ä¸­æ·»åŠ 
println!("å½“å‰ webview æ•°é‡: {}", app_handle.webview_windows().len());
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¯¼èˆªæ é«˜åº¦**ï¼šå›ºå®šä¸º 60pxï¼Œå¦‚éœ€ä¿®æ”¹éœ€åŒæ­¥æ›´æ–° Rust å’Œ CSS
2. **çª—å£æ ‡ç­¾**ï¼šä¸»çª—å£å¿…é¡»ä½¿ç”¨ `"main"` ä½œä¸ºæ ‡ç­¾
3. **å†…å­˜ç®¡ç†**ï¼šé»˜è®¤ä¿æŒæ‰€æœ‰åˆ›å»ºçš„ webviewï¼Œå¦‚éœ€é‡Šæ”¾å¯è°ƒç”¨ `close_project()`
4. **æœ€å°çª—å£**ï¼šæœ€å°å°ºå¯¸ 1000x700ï¼Œç¡®ä¿å†…å®¹æ˜¾ç¤ºæ­£å¸¸

## ğŸš§ æœªæ¥ä¼˜åŒ–

1. **LRU ç¼“å­˜**ï¼šåªä¿æŒæœ€è¿‘ä½¿ç”¨çš„ N ä¸ª webview
2. **åˆ‡æ¢åŠ¨ç”»**ï¼šæ·»åŠ æ·¡å…¥æ·¡å‡ºæ•ˆæœ
3. **å†…å­˜ç›‘æ§**ï¼šè¶…è¿‡é˜ˆå€¼æ—¶è‡ªåŠ¨é‡Šæ”¾æœªä½¿ç”¨çš„ webview
4. **çª—å£çŠ¶æ€æŒä¹…åŒ–**ï¼šè®°ä½ç”¨æˆ·ä¸Šæ¬¡æ‰“å¼€çš„é¡¹ç›®

---

ç°åœ¨ä½ å¯ä»¥è¿è¡Œ `pnpm tauri dev` æ¥æµ‹è¯•æ–°çš„å¤š webview æ–¹æ¡ˆï¼
