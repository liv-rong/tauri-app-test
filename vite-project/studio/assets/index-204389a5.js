import{e as _,b as v,A as N}from"./index.esm-0b9baea5.js";async function C(e,r){const n=e.getReader();let t;for(;!(t=await n.read()).done;)r(t.value)}function I(e){let r,n,t,o=!1;return function(l){r===void 0?(r=l,n=0,t=-1):r=$(r,l);const i=r.length;let s=0;for(;n<i;){o&&(r[n]===10&&(s=++n),o=!1);let d=-1;for(;n<i&&d===-1;++n)switch(r[n]){case 58:t===-1&&(t=n-s);break;case 13:o=!0;case 10:d=n;break}if(d===-1)break;e(r.subarray(s,d),t),s=n,t=-1}s===i?r=void 0:s!==0&&(r=r.subarray(s),n-=s)}}function R(e,r,n){let t=A();const o=new TextDecoder;return function(l,i){if(l.length===0)n==null||n(t),t=A();else if(i>0){const s=o.decode(l.subarray(0,i)),d=i+(l[i+1]===32?2:1),f=o.decode(l.subarray(d));switch(s){case"data":t.data=t.data?t.data+`
`+f:f;break;case"event":t.event=f;break;case"id":e(t.id=f);break;case"retry":const h=parseInt(f,10);isNaN(h)||r(t.retry=h);break}}}}function $(e,r){const n=new Uint8Array(e.length+r.length);return n.set(e),n.set(r,e.length),n}function A(){return{data:"",event:"",id:"",retry:void 0}}var L=globalThis&&globalThis.__rest||function(e,r){var n={};for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&r.indexOf(t)<0&&(n[t]=e[t]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,t=Object.getOwnPropertySymbols(e);o<t.length;o++)r.indexOf(t[o])<0&&Object.prototype.propertyIsEnumerable.call(e,t[o])&&(n[t[o]]=e[t[o]]);return n};const T="text/event-stream",P=1e3,j="last-event-id";function W(e,r){var{signal:n,headers:t,onopen:o,onmessage:g,onclose:l,onerror:i,openWhenHidden:s,fetch:d}=r,f=L(r,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((h,y)=>{const c=Object.assign({},t);c.accept||(c.accept=T);let a;function u(){a.abort(),document.hidden||E()}s||document.addEventListener("visibilitychange",u);let w=P,m=0;function O(){document.removeEventListener("visibilitychange",u),window.clearTimeout(m),a.abort()}n==null||n.addEventListener("abort",()=>{O(),h()});const k=d??window.fetch,S=o??q;async function E(){var x;a=new AbortController;try{const b=await k(e,Object.assign(Object.assign({},f),{headers:c,signal:a.signal}));await S(b),await C(b.body,I(R(p=>{p?c[j]=p:delete c[j]},p=>{w=p},g))),l==null||l(),O(),h()}catch(b){if(!a.signal.aborted)try{const p=(x=i==null?void 0:i(b))!==null&&x!==void 0?x:w;window.clearTimeout(m),m=window.setTimeout(E,p)}catch(p){O(),y(p)}}}E()})}function q(e){const r=e.headers.get("content-type");if(!(r!=null&&r.startsWith(T)))throw new Error(`Expected content-type to be ${T}, Actual: ${r}`)}const B=e=>{var y;const{token:r,onMessage:n,onClose:t,onError:o,body:g,abortController:l,getAbortController:i}=e,s=l||new AbortController;i==null||i(s);const d="/completion-messages",h=`${(y=v)!=null&&y.endsWith("/")?v.slice(0,-1):v}${d.startsWith("/")?"":"/"}${d}`;return W(h,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify(g),signal:s.signal,async onopen(c){var a;if(c.status>=400){const u=await c.clone().json();throw new Error(u.message||((a=u.detail)==null?void 0:a.message)||u.detail||u.msg)}},onmessage(c){var u;let a={};try{a=JSON.parse(c.data)}catch{}if(a.event==="workflow_finished"&&((u=a.data)==null?void 0:u.status)==="failed")throw new Error(a.data.error);if(a.event==="error")throw new Error(["rate limit exceeded","invalid param","context length exceeded"].includes(a.code)?a.code:a.message);n==null||n(a)},onclose(){t==null||t()},onerror(c){throw c},openWhenHidden:!0}).catch(c=>{o==null||o(H(c))})},H=e=>{if(!e)return"Unexpected error";if(typeof e=="string")return e;if(e.name==="AbortError")return"Request aborted";if(e!=null&&e.message)return e.message;try{return JSON.stringify(e)}catch{return"Unexpected error"}},J=_({prefix:v,headers:{Authorization:`Bearer ${N}`,"Content-Type":"application/json",Accept:"application/json"}});function z(e){return J.post("/completion-messages",{body:JSON.stringify({response_mode:"blocking",query:e||"",inputs:{}})})}export{z as g,B as h};
