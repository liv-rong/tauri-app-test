import{m as r,W as se,p as ae,q as ne,D as le,t as p,z as ie,V as ce}from"./BaseSelectComp-10db33f3.js";import{r as v}from"./index-626914f7.js";import"./index.esm-0b9baea5.js";import"./canvas-0ce26167.js";import"./index-383ddd63.js";const ue="ppt_brush-module__editButton--yQa0O",de="ppt_brush-module__editIcon--gmN-W",he="ppt_brush-module__container--EaSyy",fe="ppt_brush-module__toolList--51t2c",me="ppt_brush-module__toolItem--EqpSw",pe="ppt_brush-module__toolIcon--2HGiV",ve="ppt_brush-module__toolLabel--HOY-6",we="ppt_brush-module__activeIndicator--CPDb5",ge="ppt_brush-module__colorGrid--mwrRZ",be="ppt_brush-module__colorButton---vwT8",_e="ppt_brush-module__white--mTubY",xe="ppt_brush-module__active--CI1-w",a={editButton:ue,editIcon:de,container:he,toolList:fe,toolItem:me,toolIcon:pe,toolLabel:ve,activeIndicator:we,colorGrid:ge,colorButton:be,white:_e,active:xe},ye=["#000000","#ffffff","#ff3b30","#ff9500","#ffcc00","#34c759","#32ade6","#007aff","#5856d6","#8e8e93"],Be=({canvas:e,onSave:C,mode:O,brushValue:g,onBrushChange:D,onModeChange:k})=>{const[_,j]=v.useState(!1),[$,S]=v.useState({top:0,left:0}),w=v.useRef(null),E=v.useRef(null),W=()=>{if(w.current&&(clearTimeout(w.current),w.current=null),E.current){const t=E.current.getBoundingClientRect();S({top:t.top-218,left:t.left+t.width/2-100})}j(!0),k("draw")},x=()=>{w.current=window.setTimeout(()=>{j(!1),k("")},100)},V=()=>{_?x():W()},G=()=>{w.current&&(clearTimeout(w.current),w.current=null)},z=()=>{x()};v.useEffect(()=>{if(_){const t=s=>{const c=s.target;!c.closest(`.${a.container}`)&&!c.closest(`.${a.editButton}`)&&x()};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}}},[_]);const Y=()=>{e&&(!e||!e.getContext()||(e.getObjects().forEach(t=>{t.type==="path"&&!t.id&&e.remove(t)}),e.renderAll(),C(),k(""),D({mode:""}),x()))},F=v.useMemo(()=>[{key:"laser",label:"激光笔",icon:r.jsx(se,{})},{key:"pen",label:"笔",icon:r.jsx(ae,{})},{key:"marker",label:"荧光笔",icon:r.jsx(ne,{})},{key:"eraser",label:"橡皮擦",icon:r.jsx(le,{})}],[]),Q=({diameter:t=18,strokeWidth:s=2,fill:c="transparent",stroke:y="rgba(0, 0, 0, 1)"})=>{const u=Math.max(1,Math.floor(t/2)),b=`<svg xmlns="http://www.w3.org/2000/svg" width="${u*2}" height="${u*2}">
      <circle cx="${u}" cy="${u}" r="${u-s/2}" fill="${c}" stroke="${y}" stroke-width="${s}"/>
    </svg>`;return{url:`data:image/svg+xml;base64,${btoa(b)}`,r:u}};return v.useEffect(()=>{if(!e||!e.getContext())return;const{mode:t,color:s}=g;e.isDrawingMode=!1;const c=[];switch(t){case"pen":e.isDrawingMode=!0,e.freeDrawingBrush=new p.fabric.PencilBrush(e),e.freeDrawingBrush.color=s,e.freeDrawingBrush.width=2,e.freeDrawingBrush.shadow=void 0,e.__laserPathHandler&&(e.off("path:created",e.__laserPathHandler),e.__laserPathHandler=void 0);break;case"marker":e.isDrawingMode=!0,e.freeDrawingBrush=new p.fabric.PencilBrush(e);const u=s.includes("rgba")?s:`rgba(${parseInt(s.slice(1,3),16)}, ${parseInt(s.slice(3,5),16)}, ${parseInt(s.slice(5,7),16)}, 0.4)`;e.freeDrawingBrush.color=u,e.freeDrawingBrush.width=6,e.freeDrawingBrush.globalCompositeOperation="source-over",e.__laserPathHandler&&(e.off("path:created",e.__laserPathHandler),e.__laserPathHandler=void 0);break;case"laser":e.isDrawingMode=!0,e.freeDrawingBrush=new p.fabric.PencilBrush(e),e.freeDrawingBrush.color=s,e.freeDrawingBrush.width=2,e.freeDrawingBrush.shadow=new p.fabric.Shadow({color:s,blur:6,offsetX:0,offsetY:0});const b=m=>{const h=(m==null?void 0:m.path)||(m==null?void 0:m.target);h&&(h.selectable=!1,e.requestRenderAll(),setTimeout(()=>{var o;(o=h.animate)==null||o.call(h,"opacity",0,{duration:700,onChange:e.renderAll.bind(e),onComplete:()=>{e.remove(h),e.requestRenderAll()}})},500))};e.__laserPathHandler&&e.off("path:created",e.__laserPathHandler),e.on("path:created",b),e.__laserPathHandler=b;break;case"eraser":{e.isDrawingMode=!1;const m=18;let h=!1;const o=e.upperCanvasEl,B=e.lowerCanvasEl,P=o==null?void 0:o.style.pointerEvents,I=B==null?void 0:B.style.pointerEvents,L=()=>{if(!o)return;const{url:n,r:d}=Q({diameter:18,stroke:"rgba(0,0,0,0.8)"}),l=`url(${n}) ${d} ${d}, none`;e.setCursor(l),e.defaultCursor=l,e.hoverCursor=l,e.requestRenderAll(),o.style.setProperty("cursor",l,"important")},N=()=>{if(!o)return;const n="default";e.setCursor(n),e.defaultCursor=n,e.hoverCursor=n,e.requestRenderAll(),o.style.setProperty("cursor",n,"important")},M=n=>{const d=m/2,l=new p.fabric.Point(n.x-d,n.y-d),J=new p.fabric.Point(n.x+d,n.y+d),K=(i,f)=>!(i.left+i.width<f.left||f.left+f.width<i.left||i.top+i.height<f.top||f.top+f.height<i.top),U={left:l.x,top:l.y,width:m,height:m};e.getObjects().forEach(i=>{var f;if(i.type==="path"&&!(i!=null&&i.id)){const ee=(f=i.intersectsWithRect)==null?void 0:f.call(i,l,J),te=i.getBoundingRect(!0),re=K(te,U),oe=i.containsPoint(n);(ee||re||oe)&&e.remove(i)}}),e.requestRenderAll()},H=n=>{const d=n.e,l=e.getPointer(d,!1);l&&(h=!0,M(new p.fabric.Point(l.x,l.y)))},R=n=>{const d=n.e,l=e.getPointer(d,!1);l&&h&&M(new p.fabric.Point(l.x,l.y))},A=()=>{h=!1,C()},X=()=>L(),Z=()=>{h=!1,N()};L(),e.on("mouse:move",R),e.on("mouse:down",H),e.on("mouse:up",A);const q=()=>X(),T=()=>Z();o==null||o.addEventListener("mouseenter",q),o==null||o.addEventListener("mouseleave",T),c.push(()=>e.off("mouse:move",R)),c.push(()=>e.off("mouse:down",H)),c.push(()=>e.off("mouse:up",A)),c.push(()=>o==null?void 0:o.removeEventListener("mouseenter",q)),c.push(()=>o==null?void 0:o.removeEventListener("mouseleave",T)),c.push(()=>{N(),o&&P!==void 0&&(o.style.pointerEvents=P),B&&I!==void 0&&(B.style.pointerEvents=I)});break}case"":default:e.isDrawingMode=!1;break}e.renderAll();const y=()=>{C()};return e.on("path:created",y),()=>{try{e&&e.getContext()&&!e.isDestroyed&&(e.off("path:created",y),c.forEach(u=>{try{u()}catch{}}),e.isDrawingMode=!1,e.renderAll())}catch{}}},[g,O,e]),r.jsxs(r.Fragment,{children:[r.jsx("div",{ref:E,className:a.editButton,onClick:V,children:r.jsx(ie,{className:a.editIcon})}),_&&r.jsxs("div",{className:a.container,style:{top:$.top,left:$.left},onMouseEnter:G,onMouseLeave:z,children:[r.jsxs("ul",{className:a.toolList,children:[F.map(t=>{const s=t.key===(g==null?void 0:g.mode);return r.jsxs("li",{onClick:()=>D({mode:t.key}),"data-active":s,className:a.toolItem,children:[r.jsx("span",{className:a.toolIcon,children:t.icon}),r.jsx("span",{className:a.toolLabel,children:t.label}),s&&r.jsx("span",{className:a.activeIndicator})]},t.key)}),r.jsxs("li",{onClick:Y,className:a.toolItem,children:[r.jsx("span",{className:a.toolIcon,children:r.jsx(ce,{})}),r.jsx("span",{className:a.toolLabel,children:"擦除所有墨迹"})]})]}),r.jsx("div",{className:a.colorGrid,children:ye.map(t=>{const s=t==="#ffffff",c=t===(g==null?void 0:g.color);return r.jsx("button",{onClick:()=>D({color:t}),"aria-label":`color-${t}`,className:`${a.colorButton} ${s?a.white:""} ${c?a.active:""}`,style:{background:t}},t)})})]})]})},$e=v.memo(Be);export{$e as default};
