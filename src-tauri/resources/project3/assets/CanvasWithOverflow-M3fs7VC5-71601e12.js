import{t as w,m as D,X as S}from"./BaseSelectComp-10db33f3.js";import{r as m}from"./index-626914f7.js";import{v as q}from"./canvas-0ce26167.js";import"./index.esm-0b9baea5.js";import"./index-383ddd63.js";var V=Object.defineProperty,L=Object.getOwnPropertySymbols,H=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable,W=(r,e,t)=>e in r?V(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,F=(r,e)=>{for(var t in e||(e={}))H.call(e,t)&&W(r,t,e[t]);if(L)for(var t of L(e))J.call(e,t)&&W(r,t,e[t]);return r},j=(r,e,t)=>W(r,typeof e!="symbol"?e+"":e,t),U=(r,e,t)=>new Promise((o,c)=>{var s=i=>{try{l(t.next(i))}catch(a){c(a)}},n=i=>{try{l(t.throw(i))}catch(a){c(a)}},l=i=>i.done?o(i.value):Promise.resolve(i.value).then(s,n);l((t=t.apply(r,e)).next())});const X=new Map([["720x960",{width:720,height:960}],["768x1024",{width:768,height:1024}],["960x1280",{width:960,height:1280}],["1080x1440",{width:1080,height:1440}],["2160x2880",{width:2160,height:2880}],["3240x4320",{width:3240,height:4320}]]);class _{static downloadFile(e,t){const o=document.createElement("a");o.href=e,o.setAttribute("download",t),o.click()}static isMobile(){return window.matchMedia("only screen and (max-width: 640px)").matches}static disableGestureScale(){document.addEventListener("gesturestart",t=>{t.preventDefault()},!1);let e=0;document.documentElement.addEventListener("touchend",t=>{const o=Date.now();o-e<=300&&t.preventDefault(),e=o},!1),document.addEventListener("gesturestart",t=>{t.preventDefault()})}isMobile(){return window.matchMedia("only screen and (max-width: 640px)").matches}static setDocumentTitle(e,t){const o=t?`${t} | ${e}`:e;document.title=o}}j(_,"isMacOS",()=>/Macintosh|Mac OS X/.test(navigator.userAgent));const O=class{};j(O,"delShape",r=>{const e=r==null?void 0:r.getActiveObjects();for(const t in e){const o=e[Number(t)],c=o==null?void 0:o.type;(c==="textbox"||c==="text"||c==="i-text")&&o.isEditing||(r==null||r.remove(o),r.discardActiveObject())}}),j(O,"fitToInnerArea",({canvas:r,designW:e,designH:t,lastCanvasSizeRef:o,vptAnimRef:c})=>{const s=document.getElementById("canvas-wrapper-inner"),n=r.getElement();if(!s||!n)return;const l=window.innerWidth,i=window.innerHeight,a=o.current;if(a.w!==l||a.h!==i){const v=r.renderOnAddRemove;r.renderOnAddRemove=!1,r.setDimensions({width:l,height:i}),r.renderOnAddRemove=v,o.current={w:l,h:i}}const u=s.getBoundingClientRect(),h=n.getBoundingClientRect(),g=u.width,b=u.height,f=u.left-h.left,A=u.top-h.top,x=Math.min(g/e,b/t),d=f,p=A;return O.smoothSetViewport({canvas:r,targetVpt:[x,0,0,x,d,p],vptAnimRef:c}),{scale:x,offsetX:d,offsetY:p}}),j(O,"smoothSetViewport",({canvas:r,targetVpt:e,vptAnimRef:t,duration:o=180})=>{var c;(c=t.current)!=null&&c.raf&&cancelAnimationFrame(t.current.raf);const s=r.viewportTransform?[...r.viewportTransform]:[1,0,0,1,0,0],n=e,l=performance.now(),i=u=>1-Math.pow(1-u,3),a=()=>{if(!r||!r.getContext()){t.current=null;return}const u=performance.now(),h=Math.min(1,(u-l)/o),g=i(h),b=[s[0]+(n[0]-s[0])*g,0,0,s[3]+(n[3]-s[3])*g,s[4]+(n[4]-s[4])*g,s[5]+(n[5]-s[5])*g];try{const f=r.renderOnAddRemove;r.renderOnAddRemove=!1,r.setViewportTransform(b),r.renderOnAddRemove=f,r.renderAll()}catch{t.current=null;return}if(h<1)t.current={raf:requestAnimationFrame(a),start:l,from:s,to:n,duration:o};else{try{r.setViewportTransform(n),r.renderAll()}catch{}t.current=null}};t.current={raf:requestAnimationFrame(a),start:l,from:s,to:n,duration:o}}),j(O,"getActiveObjectType",r=>{const e={type:"",object:null};if(typeof r.getActiveObject()>"u")return e;const t=r.getActiveObject();switch(t!=null&&t.type&&(e.type=t==null?void 0:t.type),t==null?void 0:t.type){case"textbox":e.object=t;break;case"text":e.object=t;break;case"i-text":e.object=t;break;default:e.object=t}return e}),j(O,"getActiveFontStyle",r=>{if(!r)return{styles:{}};const e=r==null?void 0:r.getActiveObject();return e?e instanceof w.fabric.Textbox||e instanceof w.fabric.Text||e instanceof w.fabric.IText?(e.fontFamily,{fontSize:e.fontSize,fontFamily:e.fontFamily,fontWeight:e.fontWeight,underline:e.underline,overline:e.overline,linethrough:e.linethrough,fontStyle:e.fontStyle,fill:e.fill,backgroundColor:e.backgroundColor,styles:e.styles,textAlign:e.textAlign,lineHeight:e.lineHeight,textBackgroundColor:e.textBackgroundColor,stroke:e.stroke,strokeWidth:e.strokeWidth,width:e.width,height:e.height,charSpacing:e.charSpacing}):{styles:{}}:{styles:{}}}),j(O,"isTextType",r=>{if(!r)return!1;const e=r.getActiveObject();return e?e instanceof w.fabric.Textbox||e instanceof w.fabric.Text||e instanceof w.fabric.IText:!1}),j(O,"exportCanvasSvg",r=>{if(!r)return;const e=r.toSVG(),t=new Blob([e],{type:"image/svg+xml"}),o=URL.createObjectURL(t);_.downloadFile(o,"image.svg")}),j(O,"exportCanvasImg",(r,e={})=>{if(!r)return;const t=e.format||"png",o=r.toDataURL(F({format:t,quality:1,multiplier:1},e));_.downloadFile(o,`image.${t}`)}),j(O,"exportCanvasImgByJson",(r,e={},t)=>{var o,c;const{width:s=720,height:n=960}=(o=X.get(t))!=null?o:{},l=s/S.width||n/S.height,i=(c=e.format)!=null?c:"png",a=document.createElement("canvas"),u=new w.fabric.Canvas(a);u.setDimensions(F({},S)),u.setZoom(l),((h="png")=>{u.loadFromJSON(JSON.stringify(r),()=>{if(h==="jpg")u.setBackgroundColor("#fff",()=>{const g=u.renderAll().toDataURL({format:h,quality:1,multiplier:1,width:s,height:n});_.downloadFile(g,`image.${h}`),a.remove()});else{const g=u.renderAll().toDataURL({format:h,quality:1,multiplier:1,width:s,height:n});_.downloadFile(g,`image.${h}`),a.remove()}})})(i)}),j(O,"exportCanvasSvgByJson",r=>{const e=document.createElement("canvas"),t=new w.fabric.Canvas(e);t.setDimensions(F({},S)),t.loadFromJSON(JSON.stringify(r),()=>{t.renderAll(),O.exportCanvasSvg(t),e.remove()})});let z=O;class M{}j(M,"isTextboxPersistentBorder",(r,e)=>{try{if(!e)return;r.getObjects("textbox").forEach(t=>{const o=t;e?o.__persistentBorder&&(o.__persistentBorder=!0,o.__persistentBorderColor&&(o.__persistentBorderColor=o.__persistentBorderColor),o.__persistentBorderWidth&&(o.__persistentBorderWidth=o.__persistentBorderWidth)):o.__persistentBorder=!1,o.dirty=!0}),r.renderAll()}catch{}});class T{static mtrStyles(){w.fabric.Object.prototype.controls.mtr.withConnection=!1,w.fabric.Object.prototype.controls.mtr.y=.5,w.fabric.Object.prototype.controls.mtr.offsetY=20,w.fabric.Object.prototype.controls.mtr.cursorStyle="pointer";const e=document.createElement("img");e.src="/rotate.png",w.fabric.Object.prototype.controls.mtr.sizeX=22,w.fabric.Object.prototype.controls.mtr.sizeY=22,w.fabric.Object.prototype.controls.mtr.render=(t,o,c)=>{t.save();const s=22;t.drawImage(e,o-10,c-10,s,s),t.restore()}}static controllerStyles(){w.fabric.Object.prototype.set({borderColor:"#eab308",cornerColor:"green",cornerStrokeColor:"",borderOpacityWhenMoving:1,borderScaleFactor:2,cornerSize:10,cornerStyle:"rect",centeredScaling:!1,transparentCorners:!1,lockUniScaling:!1,hasRotatingPoint:!0})}static enforceOnlyHorizontalAnchors(e=!1){const t=w.fabric.Textbox.prototype,o=w.fabric.Object.prototype.controls;o&&(!t.controls||t.controls===o)&&(t.controls=F({},o));const c=t.controls;c&&(["tl","mt","tr","ml","mr","bl","mb","br","mtr"].forEach(s=>{c[s]&&(c[s].visible=!1)}),c.ml&&(c.ml.visible=!0),c.mr&&(c.mr.visible=!0),c.mtr&&(c.mtr.visible=!!e),t.hasControls=!0,t.hasBorders=!0,t.hasRotatingPoint=!!e)}static installHorizontalAnchorsForCanvas(e,t=!1){const o=n=>{var l;if(!(!n||n.type!=="textbox")){if(n.set({hasControls:!0,hasBorders:!0,hasRotatingPoint:!!t}),(l=n.setControlsVisibility)==null||l.call(n,{tl:!1,mt:!1,tr:!1,ml:!0,mr:!0,bl:!1,mb:!1,br:!1,mtr:!!t}),!n.setControlsVisibility&&n.controls){const i=n.controls;Object.keys(i).forEach(a=>{i[a].visible=a==="ml"||a==="mr"||t&&a==="mtr"})}n.setCoords()}},c=n=>o(n.target),s=n=>{var l;const i=((l=n.selected)==null?void 0:l[0])||n.target;o(i),e.requestRenderAll()};e.getObjects().forEach(n=>o(n)),e.requestRenderAll(),e.on("object:added",c),e.on("selection:created",s),e.on("selection:updated",s)}static installTextboxOnlyHorizontalAnchors(e,t=!0){if(!e)return;const o=w.fabric.Object.prototype.controls,c=i=>{var a;if(!(!i||i.type!=="textbox")){if(i.set({hasControls:!0,hasBorders:!0,hasRotatingPoint:!!t}),(a=i.setControlsVisibility)==null||a.call(i,{tl:!1,mt:!1,tr:!1,ml:!0,mr:!0,bl:!1,mb:!1,br:!1,mtr:!!t}),!i.setControlsVisibility&&i.controls){const u=i.controls;Object.keys(u).forEach(h=>{u[h].visible=h==="ml"||h==="mr"||t&&h==="mtr"})}i.setCoords()}},s=i=>{var a;!i||i.type==="textbox"||(o&&i.controls!==o&&(i.controls=F({},o)),i.set({hasControls:!0,hasBorders:!0,hasRotatingPoint:!0}),(a=i.setControlsVisibility)==null||a.call(i,{tl:!0,mt:!0,tr:!0,ml:!0,mr:!0,bl:!0,mb:!0,br:!0,mtr:!0}),i.setCoords())},n=i=>{const a=i.target;c(a),s(a),e.requestRenderAll()},l=i=>{var a,u,h;const g=i.selected,b=((a=i.selected)==null?void 0:a[0])||i.target;c(b),s(b);const f=e.getActiveObject();if(f&&f.type==="activeSelection"){const A=Array.isArray(g)?g.some(x=>x.type==="textbox"):!1;f.set({hasControls:!0,hasBorders:!0,hasRotatingPoint:!0}),A?(u=f.setControlsVisibility)==null||u.call(f,{tl:!1,mt:!1,tr:!1,ml:!1,mr:!1,bl:!1,mb:!1,br:!1,mtr:!0}):(h=f.setControlsVisibility)==null||h.call(f,{tl:!0,mt:!0,tr:!0,ml:!0,mr:!0,bl:!0,mb:!0,br:!0,mtr:!0}),f.setCoords()}e.requestRenderAll()};e.getObjects().forEach(i=>{c(i),s(i)}),e.requestRenderAll(),e.on("object:added",n),e.on("selection:created",l),e.on("selection:updated",l)}}j(T,"textBoxStyle",()=>{const r=w.fabric.Textbox.prototype._render;w.fabric.Textbox.prototype._render=function(e){if(r.call(this,e),!this.__persistentBorder)return;const t=this.width||0,o=this.height||0;t<=0||o<=0||(e.save(),e.strokeStyle=this.__persistentBorderColor||"#999999",e.lineWidth=this.__persistentBorderWidth||1,e.strokeRect(-t/2,-o/2,t,o),e.restore())}});const N=r=>{const e=m.useRef([]);m.useEffect(()=>{var t;if(!r)return;const o=(t=r.getSelectionElement)!=null&&t.call(r)?r.getSelectionElement():r.upperCanvasEl;if(!o)return;o.setAttribute("tabindex","0"),o.style.outline="none",o.style.boxShadow="none";const c=n=>{if((n.key==="Delete"||n.key==="Backspace")&&z.delShape(r),(n.ctrlKey||n.metaKey)&&n.key==="c"){n.preventDefault();const l=r.getActiveObjects();l.length>0&&(e.current=l)}if((n.ctrlKey||n.metaKey)&&n.key==="v"&&(n.preventDefault(),e.current&&U(void 0,null,function*(){try{r.discardActiveObject();const l=new Map;e.current.forEach(b=>{const f=b.id;f&&l.set(f,q())});const i=20,a=20,u=e.current.map(b=>{const f=b.toObject(["data","selectable","id","linkId"]);return new Promise(A=>{w.fabric.util.enlivenObjects([f],x=>{const d=x[0];A(d)},"fabric")})}),h=yield Promise.all(u);h.forEach((b,f)=>{var A,x;const d=e.current[f],p=b.id;p&&l.has(p)&&(b.id=l.get(p));const v=d.linkId;return v&&l.has(v)?b.linkId=l.get(v):delete b.linkId,b.set({left:((A=d.left)!=null?A:0)+i,top:((x=d.top)!=null?x:0)+a}),b.canvas=void 0,r.add(b),b});const g=new w.fabric.ActiveSelection(h,{canvas:r});r.setActiveObject(g),r.requestRenderAll()}catch{}})),["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(n.key)){n.preventDefault();const l=r.getActiveObject();if(l){const i=n.shiftKey?10:1;let a=l.left||0,u=l.top||0;switch(n.key){case"ArrowLeft":a-=i;break;case"ArrowRight":a+=i;break;case"ArrowUp":u-=i;break;case"ArrowDown":u+=i;break}l.set({left:a,top:u}),r.renderAll()}}},s=()=>{o.focus({preventScroll:!0})};return r.on("mouse:down",s),o.addEventListener("keydown",c),()=>{try{r.off("mouse:down",s)}catch{}try{o.removeEventListener("keydown",c)}catch{}}},[r])},K=(r,e={})=>{const{wait:t=1e3,leading:o=!1,trailing:c=!0,maxWait:s}=e,n=m.useRef(r),l=m.useRef(null),i=m.useRef(null),a=m.useRef(0),u=m.useRef(0),h=m.useRef();n.current=r;const g=m.useCallback(()=>{l.current&&(clearTimeout(l.current),l.current=null),i.current&&(clearTimeout(i.current),i.current=null)},[]),b=m.useCallback(y=>{const C=h.current;return u.current=y,h.current=void 0,n.current(...C)},[]),f=m.useCallback((y,C)=>{g(),l.current=setTimeout(y,C)},[g]),A=m.useCallback(y=>{const C=y-a.current,B=y-u.current;return a.current===0||C>=t||C<0||s!==void 0&&B>=s},[t,s]),x=m.useCallback(()=>{const y=Date.now();if(A(y))return d(y);const C=y-a.current,B=y-u.current,I=t-C,P=s?Math.min(I,s-B):I;f(x,P)},[A,t,s,f]),d=m.useCallback(y=>{if(l.current=null,c&&h.current)return b(y);h.current=void 0},[c,b]),p=m.useCallback(y=>(u.current=y,f(x,t),o?b(y):void 0),[o,b,f,x,t]),v=m.useCallback(()=>{g(),a.current=0,u.current=0,h.current=void 0},[g]),E=m.useCallback(()=>l.current===null?void 0:d(Date.now()),[d]),k=m.useCallback(()=>l.current!==null,[]),R=m.useCallback((...y)=>{const C=Date.now(),B=A(C);if(h.current=y,a.current=C,B)return l.current===null?p(C):s?(f(x,t),b(C)):p(C);l.current===null&&f(x,t)},[A,p,s,f,x,t,b]);return m.useEffect(()=>()=>{g()},[g]),{run:R,cancel:v,flush:E,pending:k}},te=m.forwardRef(({currentCanvasId:r,canvasList:e,handleSave:t,isTemplate:o=!1,isPreview:c=!1},s)=>{const[n,l]=m.useState(null),i=m.useRef(null),a=m.useRef(null),[u,h]=m.useState(800),g=m.useRef({w:0,h:0}),b=m.useRef(null),f=m.useRef(null),A=m.useRef(null);N(c?null:n),m.useEffect(()=>{const d=new w.fabric.Canvas(i.current,{preserveObjectStacking:!0,controlsAboveOverlay:!0,enablePointerEvents:!c,skipTargetFind:c,selection:!c});c&&(d.selection=!1,d.hoverCursor="default",d.defaultCursor="default"),l(d),a.current=d;const p=v=>{A.current={x:v.clientX,y:v.clientY}};return window.addEventListener("mousemove",p,{passive:!0}),typeof s=="function"?s(d):typeof s=="object"&&s&&(s.current=d),()=>{var v;(v=f.current)!=null&&v.raf&&(cancelAnimationFrame(f.current.raf),f.current=null),typeof s=="function"?s(null):typeof s=="object"&&s&&(s.current=null),a.current=null,d._winResize&&typeof window<"u"&&window.removeEventListener("resize",d._winResize),window.removeEventListener("mousemove",p),d.dispose()}},[]),m.useEffect(()=>{if(!n)return;const d=e.find(p=>p.id===r);if(!d){n.clear(),n.renderAll();return}n.loadFromJSON(d,()=>{c&&n.forEachObject(p=>{p.set({selectable:!1,evented:!1,hasControls:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,hoverCursor:"default"})}),n.renderAll()}),M.isTextboxPersistentBorder(n,o)},[n,r,o,c]);const{run:x}=K(()=>{t==null||t()},{wait:500});return m.useEffect(()=>{if(!n)return;const d=()=>x(),p=()=>x(),v=()=>x();return n.on("object:modified",d),n.on("object:added",p),n.on("object:removed",v),()=>{n.off("object:modified",d),n.off("object:added",p),n.off("object:removed",v)}},[n,x]),m.useEffect(()=>{if(!n||c)return;T.mtrStyles(),T.controllerStyles(),T.textBoxStyle(),T.installTextboxOnlyHorizontalAnchors(n),n.getObjects("textbox").forEach(p=>{const v=p;v.__persistentBorder=!!o,v.dirty=!0}),n.renderAll();const d=p=>{const v=p.target;v&&v.type==="textbox"&&v.data&&(v.__persistentBorder=!!o,v.dirty=!0,n.requestRenderAll())};return n.on("object:added",d),()=>{n.off("object:added",d)}},[n,o,c]),m.useEffect(()=>{if(!n)return;const d=()=>{const p=S.width,v=S.height,E=p/v;let k;if(c){const R=window.innerHeight*E;k=Math.min(window.innerWidth,R)}else{const R=window.innerWidth*.7,y=window.innerHeight*.7*E;k=Math.min(R,y)}h(k),b.current&&cancelAnimationFrame(b.current),b.current=requestAnimationFrame(()=>{setTimeout(()=>{z.fitToInnerArea({canvas:n,designW:p,designH:v,lastCanvasSizeRef:g,vptAnimRef:f})},0)})};return window.addEventListener("resize",d),d(),()=>{window.removeEventListener("resize",d)}},[n,c]),m.useEffect(()=>{if(!n)return;const d=S.width,p=S.height,v=document.getElementById("canvas-wrapper-inner"),E=document.getElementById("canvas-container"),k=[],R=()=>{b.current&&cancelAnimationFrame(b.current),b.current=requestAnimationFrame(()=>{requestAnimationFrame(()=>{z.fitToInnerArea({canvas:n,designW:d,designH:p,lastCanvasSizeRef:g,vptAnimRef:f})})})};if(v){const y=new ResizeObserver(R);y.observe(v),k.push(y)}if(E){const y=new ResizeObserver(R);y.observe(E),k.push(y)}return R(),()=>{k.forEach(y=>y.disconnect())}},[n]),D.jsxs("div",{id:"canvas-container",style:{position:"relative",display:"flex",flex:"1 1 0%",alignItems:"center",justifyContent:"center",overflow:"auto",backgroundColor:"#f9fafb",color:"black"},children:[D.jsx("div",{id:"canvas-wrapper-inner",style:{width:u,height:u/16*9,pointerEvents:"none",position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)",border:"1px solid #e5e7eb",backgroundColor:"white",boxShadow:"0 1px 2px 0 rgb(0 0 0 / 0.05)"}}),D.jsx("canvas",{ref:i})]})});export{te as default};
